---
import Layout from "../layouts/Layout.astro";
import stationsData from "../../stations.json";

// Country Code to Name Mapping
const countryNames: Record<string, string> = {
	AR: "Argentina",
	BO: "Bolivia",
	BR: "Brasil",
	CL: "Chile",
	CR: "Costa Rica",
	EC: "Ecuador",
	MX: "México",
	PA: "Panamá",
	PY: "Paraguay",
	PE: "Perú",
	DO: "República Dominicana",
	UY: "Uruguay",
	TR: "Tropicalida",
	AL: "Alfa Radio",
};

// Get list of countries
const countries = Object.keys(stationsData);
const initialCountry = countries[0];
---

<Layout title="Radio Disney Latino">
	<main class="flex-1 flex flex-col h-screen overflow-hidden">
		<!-- Header -->
		<header
			class="p-6 bg-black/50 backdrop-blur-md border-b border-white/5 flex items-center gap-4 z-10"
		>
			<div
				class="w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/20"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					class="w-6 h-6 text-white"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
					><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"></path><path
						d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"></path><circle
						cx="12"
						cy="12"
						r="2"></circle><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"
					></path><path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"
					></path></svg
				>
			</div>
			<h1
				class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-white/70"
			>
				Radio Disney Latino
			</h1>
		</header>

		<!-- Mobile Country Select (Sticky) -->
		<div
			class="md:hidden sticky top-0 z-20 bg-black/80 backdrop-blur-xl border-b border-white/10 p-4"
		>
			<select
				id="country-select-mobile"
				class="w-full bg-white/10 border border-white/10 text-white rounded-lg px-4 py-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 font-medium"
			>
				<option value="" disabled selected>Select a country</option>
				{
					countries.map((country) => (
						<option value={country}>
							{countryNames[country] || country}
						</option>
					))
				}
			</select>
			<div
				class="absolute right-8 top-1/2 -translate-y-1/2 pointer-events-none text-white/50"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					class="w-5 h-5"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg
				>
			</div>
		</div>

		<div class="flex flex-1 overflow-hidden">
			<!-- Sidebar / Country List (Desktop) -->
			<aside
				class="w-64 bg-black/20 border-r border-white/5 overflow-y-auto hidden md:block"
			>
				<div class="p-4">
					<h2
						class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4 px-2"
					>
						Countries
					</h2>
					<div class="space-y-1" id="country-list-desktop">
						{
							countries.map((country) => (
								<button
									class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-white/5 text-slate-400 hover:text-white data-[active=true]:bg-purple-500/10 data-[active=true]:text-purple-400 data-[active=true]:border-l-2 data-[active=true]:border-purple-500"
									data-country={country}
									data-active={country === initialCountry}
								>
									{countryNames[country] || country}
								</button>
							))
						}
					</div>
				</div>
			</aside>

			<!-- Main Content / Station Grid -->
			<div
				class="flex-1 overflow-y-auto p-6 md:p-8 bg-gradient-to-b from-[#050505] to-black"
			>
				<div
					id="stations-container"
					class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
				>
					<!-- Stations will be injected here -->
				</div>
			</div>
		</div>

		<!-- Player Bar -->
		<div
			class="h-24 bg-black/80 backdrop-blur-xl border-t border-white/10 px-6 flex items-center justify-between z-30 relative"
		>
			<!-- Track Info -->
			<div class="flex items-center gap-4 w-1/3 min-w-0">
				<div
					class="w-14 h-14 rounded-lg bg-white/5 flex-shrink-0 overflow-hidden relative group border border-white/5"
				>
					<img
						id="player-art"
						src="/RD256.png"
						alt="Album Art"
						class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
					/>
				</div>
				<div class="min-w-0">
					<h3
						id="player-title"
						class="text-white font-medium truncate text-lg leading-tight"
					>
						Select a Station
					</h3>
					<p
						id="player-artist"
						class="text-slate-500 text-sm truncate"
					>
						Radio Disney
					</p>
				</div>
			</div>

			<!-- Controls -->
			<div class="flex flex-col items-center gap-2 w-1/3">
				<div class="flex items-center gap-6">
					<button
						class="text-slate-400 hover:text-white transition-colors hover:scale-110 active:scale-95"
						id="btn-prev"
						aria-label="Previous"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							class="w-8 h-8"
							viewBox="0 0 24 24"
							fill="currentColor"
							><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></svg
						>
					</button>
					<button
						id="btn-play"
						class="w-14 h-14 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-lg shadow-white/5"
						aria-label="Play"
					>
						<svg
							id="icon-play"
							xmlns="http://www.w3.org/2000/svg"
							class="w-7 h-7 ml-1"
							viewBox="0 0 24 24"
							fill="currentColor"
							><path d="M8 5v14l11-7z"></path></svg
						>
						<svg
							id="icon-pause"
							xmlns="http://www.w3.org/2000/svg"
							class="w-7 h-7 hidden"
							viewBox="0 0 24 24"
							fill="currentColor"
							><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"
							></path></svg
						>
						<svg
							id="icon-loading"
							xmlns="http://www.w3.org/2000/svg"
							class="w-7 h-7 animate-spin hidden"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"
							><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg
						>
					</button>
					<button
						class="text-slate-400 hover:text-white transition-colors hover:scale-110 active:scale-95"
						id="btn-next"
						aria-label="Next"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							class="w-8 h-8"
							viewBox="0 0 24 24"
							fill="currentColor"
							><path d="m6 18 8.5-6L6 6zM16 6v12h2V6z"
							></path></svg
						>
					</button>
				</div>
			</div>

			<!-- Volume / Extra -->
			<div class="w-1/3 flex justify-end items-center gap-4">
				<div class="flex items-center gap-2">
					<div class="w-2 h-2 rounded-full bg-red-500 animate-pulse">
					</div>
					<div
						class="text-xs text-slate-500 font-mono font-bold tracking-widest"
					>
						LIVE
					</div>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script>
	import Hls from "hls.js";

	// Data
	// @ts-ignore
	import stationsData from "../../stations.json";

	// Flatten stations for global navigation
	const allStations: any[] = [];
	Object.keys(stationsData).forEach((country) => {
		(stationsData as any)[country].forEach((station: any) => {
			allStations.push({ ...station, country });
		});
	});

	// DOM Elements
	const btnPlay = document.getElementById("btn-play") as HTMLButtonElement;
	const btnNext = document.getElementById("btn-next") as HTMLButtonElement;
	const btnPrev = document.getElementById("btn-prev") as HTMLButtonElement;
	const iconPlay = document.getElementById("icon-play") as HTMLElement;
	const iconPause = document.getElementById("icon-pause") as HTMLElement;
	const iconLoading = document.getElementById("icon-loading") as HTMLElement;
	const playerTitle = document.getElementById("player-title") as HTMLElement;
	const playerArtist = document.getElementById(
		"player-artist",
	) as HTMLElement;
	const stationsContainer = document.getElementById(
		"stations-container",
	) as HTMLElement;
	const countryBtnsDesktop = document.querySelectorAll(
		"#country-list-desktop button",
	);
	const countrySelectMobile = document.getElementById(
		"country-select-mobile",
	) as HTMLSelectElement;

	// State
	let currentAudio: HTMLAudioElement | null = null;
	let currentHls: Hls | null = null;
	let currentStation: any = null;
	let currentCountry = Object.keys(stationsData)[0];
	let isTransitioning = false;

	// Initialize
	function init() {
		renderStations(currentCountry);
		setupEventListeners();

		// Check URL params
		const params = new URLSearchParams(window.location.search);
		const countryParam = params.get("country");
		const idParam = params.get("id");

		if (countryParam && (stationsData as any)[countryParam]) {
			switchCountry(countryParam);
			if (idParam) {
				const station = (stationsData as any)[countryParam].find(
					(s: any) => s.id === idParam,
				);
				if (station) {
					playStation(countryParam, station);
				}
			}
		}
	}

	function setupEventListeners() {
		btnPlay.addEventListener("click", togglePlay);
		btnNext.addEventListener("click", playNext);
		btnPrev.addEventListener("click", playPrev);

		countryBtnsDesktop.forEach((btn) => {
			btn.addEventListener("click", (e) => {
				const country = (e.currentTarget as HTMLElement).dataset
					.country;
				if (country) switchCountry(country);
			});
		});

		countrySelectMobile.addEventListener("change", (e) => {
			const country = (e.target as HTMLSelectElement).value;
			if (country) switchCountry(country);
		});

		// Media Session Actions
		if ("mediaSession" in navigator) {
			navigator.mediaSession.setActionHandler("play", () => {
				if (currentAudio) currentAudio.play();
			});
			navigator.mediaSession.setActionHandler("pause", () => {
				if (currentAudio) currentAudio.pause();
			});
			navigator.mediaSession.setActionHandler("stop", () => {
				if (currentAudio) currentAudio.pause();
			});
			navigator.mediaSession.setActionHandler("previoustrack", playPrev);
			navigator.mediaSession.setActionHandler("nexttrack", playNext);

			// Disable seeking
			navigator.mediaSession.setActionHandler("seekbackward", null);
			navigator.mediaSession.setActionHandler("seekforward", null);
			navigator.mediaSession.setActionHandler("seekto", null);
		}
	}

	function switchCountry(country: string) {
		currentCountry = country;

		// Update UI
		countryBtnsDesktop.forEach((btn) => {
			const isActive = (btn as HTMLElement).dataset.country === country;
			(btn as HTMLElement).dataset.active = isActive ? "true" : "false";
		});
		countrySelectMobile.value = country;

		renderStations(country);

		// Update URL
		const url = new URL(window.location.href);
		url.searchParams.set("country", country);
		window.history.pushState({}, "", url);
	}

	function renderStations(country: string) {
		stationsContainer.innerHTML = "";
		const stations = (stationsData as any)[country] || [];

		stations.forEach((station: any) => {
			const el = document.createElement("div");
			el.className =
				"bg-white/5 hover:bg-white/10 border border-white/5 rounded-xl p-4 cursor-pointer transition-all duration-200 group hover:-translate-y-1 hover:shadow-xl hover:shadow-purple-500/10";
			el.innerHTML = `
				<div class="flex items-start justify-between">
					<div>
						<h3 class="text-white font-semibold text-lg leading-tight mb-1">${station.name}</h3>
						<p class="text-slate-500 text-sm font-mono">${station.dial}</p>
					</div>
					<div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-all duration-200 hover:bg-white/20 hover:scale-110">
						<svg xmlns="http://www.w00/svg" class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
					</div>
				</div>
			`;
			el.addEventListener("click", () => playStation(country, station));
			stationsContainer.appendChild(el);
		});
	}

	function playNext() {
		if (!currentStation) return;
		const idx = allStations.findIndex((s) => s.id === currentStation.id);
		const nextIdx = (idx + 1) % allStations.length;
		playStation(currentCountry, allStations[nextIdx]);
	}

	function playPrev() {
		if (!currentStation) return;
		const idx = allStations.findIndex((s) => s.id === currentStation.id);
		const prevIdx = (idx - 1 + allStations.length) % allStations.length;
		playStation(currentCountry, allStations[prevIdx]);
	}

	function playStation(country: string, station: any) {
		if (
			currentStation?.id === station.id &&
			currentAudio &&
			!currentAudio.paused
		) {
			togglePlay();
			return;
		}

		// Update URL
		const url = new URL(window.location.href);
		url.searchParams.set("country", country);
		url.searchParams.set("id", station.id);
		window.history.pushState({}, "", url);

		console.log(station);

		updateMediaSession(
			`Cargando ${station.name}...`,
			station.dial,
			station.title,
		);

		// If station is in a different country, switch view
		if (country !== currentCountry) {
			switchCountry(country);
		}

		currentStation = station;
		setLoading(true);

		// Create new audio instance
		const nextAudio = new Audio();
		nextAudio.crossOrigin = "anonymous";
		let nextHls: Hls | null = null;

		const streamUrl = station.streamingUrl;
		const isM3U8 = streamUrl.includes(".m3u8");

		// Setup Audio
		if (isM3U8 && nextAudio.canPlayType("application/vnd.apple.mpegurl")) {
			// Native HLS
			nextAudio.src = streamUrl;
		} else if (isM3U8 && Hls.isSupported()) {
			// HLS.js
			nextHls = new Hls();
			nextHls.loadSource(streamUrl);
			nextHls.attachMedia(nextAudio);
		} else {
			// Standard Audio
			nextAudio.src = streamUrl;
		}

		// When ready to play
		const onReady = () => {
			// Stop previous audio
			if (currentAudio) {
				currentAudio.pause();
				currentAudio.removeAttribute("src");
				currentAudio.load();
			}
			if (currentHls) {
				currentHls.destroy();
			}

			// Swap references
			currentAudio = nextAudio;
			currentHls = nextHls;

			// Play new audio
			currentAudio.play().catch((e) => console.error("Play failed:", e));

			// Update UI
			playerTitle.innerText = station.name;
			playerArtist.innerText = station.dial;
			setLoading(false);
			updatePlayButton(true);

			// Update Media Session
			updateMediaSession(
				station.name,
				station.dial,
				station.title.split(" - ")[0],
			);

			// Attach listeners to new audio
			currentAudio.addEventListener("playing", () =>
				updatePlayButton(true),
			);
			currentAudio.addEventListener("pause", () =>
				updatePlayButton(false),
			);
			currentAudio.addEventListener("waiting", () => setLoading(true));
			currentAudio.addEventListener("canplay", () => setLoading(false));
		};

		// Listen for ready state
		if (nextHls) {
			nextHls.on(Hls.Events.MANIFEST_PARSED, onReady);
		} else {
			nextAudio.addEventListener("loadedmetadata", onReady);
			nextAudio.load();
		}
	}

	function togglePlay() {
		if (!currentAudio) return;
		if (currentAudio.paused) {
			currentAudio.play();
		} else {
			currentAudio.pause();
		}
	}

	function updatePlayButton(isPlaying: boolean) {
		if (isPlaying) {
			iconPlay.classList.add("hidden");
			iconPause.classList.remove("hidden");
			iconLoading.classList.add("hidden");
		} else {
			iconPlay.classList.remove("hidden");
			iconPause.classList.add("hidden");
			iconLoading.classList.add("hidden");
		}
	}

	function setLoading(isLoading: boolean) {
		if (isLoading) {
			iconPlay.classList.add("hidden");
			iconPause.classList.add("hidden");
			iconLoading.classList.remove("hidden");
		} else {
			if (currentAudio) {
				updatePlayButton(!currentAudio.paused);
			}
		}
	}

	function updateMediaSession(title: string, artist: string, album: string) {
		if ("mediaSession" in navigator) {
			navigator.mediaSession.metadata = new MediaMetadata({
				title: title,
				artist: artist,
				album: album,
				artwork: [
					{ src: "/RD256.png", sizes: "256x256", type: "image/png" },
					{ src: "/RD512.png", sizes: "512x512", type: "image/png" },
				],
			});
		}
	}

	// Start
	init();
</script>
